---
title: "Microserviceでの認証・認可ちょっと考えてみた"
emoji: "🌟"
type: "tech"
topics: ["microservice", "認証", "認可"]
published: false
---
# 概要

MSWでモックした状態だけど
なんとなく動く画面ができてきたので
認証・認可あたりをゴリッと実装していきたい

けど、ガチャガチャ書く前にちょっと頭を整理してみる

基本はこの素敵記事で勉強させていただきました🙇‍♂️  
https://please-sleep.cou929.nu/microservices-auth-design.html

# 認証

セキュリティは奥が深いので基本認証は他の素敵なサービス利用して実施したい
Firebase Auth, Cognito, Auth0とか色々あるけど
とりあえず昔ローカルのEmulator動かすとこまでやったのでFirebase Auth使う

## 処理の流れ

ブラウザでGoogleアカウントとかGitHubアカウントでログインしてもらう

そんで取得したトークンからEmail取得してユーザー情報取得
アクセストークンとリフレッシュトークンをユーザーに付与する

アクセストークンは短く1時間、リフレッシュトークンは1週間くらい有効にしとく

ザクっと処理の流れはこんな感じ


## 鍵のローテーション

トークンの暗号化、復号に使用する鍵セットをローテーション
退職者の人がこっそり秘密鍵パクって、なんでもできるなんで事態を避けたい

とはいえ、新しい鍵セットを作成してから
リフレッシュトークンが有効な期間（1週間）は古い鍵セットは消せない
すぐ古いの消しちゃうと、ちょっと前に認証成功した人のトークン復号出来なくて未ログインになっちゃう

# 認可

## 処理の流れ

所謂RBACで実装する
Identity Serviceの認証時にユーザーのRoleに紐づくPermissionを付与してJWTに詰め込んどく

各マイクロサービスでJWTを復号して中に入ってるPermissionで認可判定

JWTヘッダーのkidに紐づく公開鍵を各マイクロサービスのキャッシュから取得
存在しない場合IdentityServiceのJWKS Endpointからkidに紐づく公開鍵を探す
存在したら対象の公開鍵をキャッシュし復号する感じ！


各マクロサービス内のPermission名判定するところ
ベタ書きじゃなくてGolangとかのmodにして外部から適切に定数で取得できるようにしたいな...

# まとめ

やっとバックエンド周りも着手できてきた
フロントエンドも楽しいけど、UIセンス的な観点が弱いので
バックエンドとかインフラの仕組み勉強して実装するほうがやっぱり楽しいな👯‍♂️

ガツっと実装しちゃおう
